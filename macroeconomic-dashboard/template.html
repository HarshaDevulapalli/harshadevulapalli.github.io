<!DOCTYPE html>
<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900" rel="stylesheet">
<meta charset="utf-8">
<style>
/* set the CSS */

.line {
    fill: none;
    stroke: black;
    stroke-width: 3.5px;
    stroke-linejoin: round;
    stroke-linecap: bevel;
}


body {
    font-family: "Lato", sans-serif;
    font-weight: 400 font-size: 2.4em;
    color: #000000;
}

h4 {
    font-weight: 600;
    font-size: 2em;
    margin-top: 10px !important;
    margin-bottom: 0px !important;

}

h5 {
    font-weight: 600;
    font-size: 1.1em;

}

h6 {
    font-weight: 400;
    font-size: 0.75em;

}


p {
    font-weight: 600;
    font-size: 1.75em;
    margin-top: 0px !important;
    margin-bottom: 0px !important;

}



text,
.axis,
.tooltip,
a {
    font-family: "Lato", sans-serif;
    font-weight: 400 font-size: 2.4em;
}

.tooltip {
    position: absolute;
    z-index: 10;
}

.tooltip h5 {
    background-color: white;
    border: black 1px solid;
    padding: 2px;
}
</style>

<body>
    <!-- load the d3.js library -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <div id="container">
        <a id="back" href="newdashboard.html">Back to the macrotracker</a>
        <h4 id="variablename" align="left"></h4>
        <p class="headings" id="variablevalue" align="left"></p>
        <p class="headings" id="variablemonth" align="left"></p>
        <div id="chart"></div>
        <link href="https://fonts.googleapis.com/css?family=Fira+Sans+Extra+Condensed:300,400,600,900" rel="stylesheet">
        <script>
        // set the dimensions and margins of the graph
        var margin = { top: 30, right: 30, bottom: 30, left: 30 },
            width = "100%",
            height = 500
        margin.top - margin.bottom;

        browserwidth = 0.9*$(document).width();
        // parse the date / time
        var parseTime = d3.timeParse("%b %Y");

        d3.json("dashboard-rawdata.json", function(error, Data) {

            if (error) throw error;
            // set the ranges
            var x = d3.scaleTime().range([5, browserwidth - 100]);
            var y = d3.scaleLinear().range([height, 0]);

            var index = getQueryVariable("index")

            const values = Data.data[index].values
            const replacer = (key, value) => value === null ? '' : value // specify how you want to handle null values here
            const header = Object.keys(values[0])
            let csv = values.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(','))
            csv.unshift(header.join(','))
            csv = csv.join('\r\n')



            $('#download').click(function() {
                filename = 'export.csv';

                if (!csv.match(/^data:text\/csv/i)) {
                    csv = 'data:text/csv;charset=utf-8,' + csv;
                }

                data = encodeURI(csv);

                link = document.createElement('a');
                link.setAttribute('href', data);
                link.setAttribute('download', filename);
                link.click();
            })


            // define the line
            var valueline = d3.line()
                .x(function(d) { return x(d.Year); })
                .y(function(d) { return y(d.Value); });

            // append the svg obgect to the body of the page
            // appends a 'group' element to 'svg']
            // moves the 'group' element to the top left margin]

            var svg = d3.select("#chart").selectAll("svg")
                .data([Data.data[index]])
                .enter().append("svg")
                .attr("width", "100%")
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")")
                .each(multiple)
                .call(responsivefy);

            var tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip");

            var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];


            function multiple(Variable) {

                variablename = Variable.variable + " "+Variable.suffix
                d3.select("#variablename").text(variablename)

                var svg = d3.select(this);
                data = Variable.values


                data.forEach(function(d) {

                    d.Year = parseTime(d.Year);
                    d.Value = +d.Value;
                });

                var extent = d3.extent(data, function(d) { return d.Year; })

                // Scale the range of the data
                x.domain(extent);

                buffer = (d3.max(data, function(d) { return +d.Value; }) - d3.min(data, function(d) { return +d.Value; })) / 10

                y.domain([d3.min(data, function(d) { return +d.Value; }) - buffer, d3.max(data, function(d) { return +d.Value; }) + buffer]);

                if (index == 12 || index == 13) {


                    var chartheight = y(Variable.upperrange) - y(Variable.lowerrange)

                    if (data[data.length - 1]['Value'] < Variable.upperrange) {


                        var arrow = "▲"

                    } else if (data[data.length - 1]['Value'] > Variable.lowerrange) {


                        var arrow = "▼"
                    } else {


                        var arrow = "◀ ▶"
                    }


                } else {

                    var chartheight = y(Variable.lowerrange) - y(Variable.upperrange)

                    if (data[data.length - 1]['Value'] < Variable.lowerrange) {


                        var arrow = "▼"

                    } else if (data[data.length - 1]['Value'] > Variable.upperrange) {


                        var arrow = "▲"
                    } else {


                        var arrow = "◀ ▶"
                    }

                }



                if (arrow == "▲") {
                    relative = "above"
                } else if (arrow == "▼") {
                    relative = "below"
                } else {
                    relative = "in  line"
                }

                var formatDate = d3.timeFormat("%B %Y");

                variablevalue = data[data.length - 1]['Value'].toFixed(2)
                variablemonth = data[data.length - 1]['Year']
                variabletrend = "It is " + relative + " the five year average."

                d3.select("#variablevalue").text(variablevalue)
                d3.select("#variablemonth").text(formatDate(variablemonth))
                d3.select("#variabletrend").text(variabletrend)


                svg.append("g")
                    .attr("class", "band")
                    .append("rect")
                    .attr("x", 0)
                    .attr("y", y(Variable.upperrange))
                    .attr("height", chartheight)
                    .attr("width", 0.9*browserwidth)
                    .style("stroke", "#FABD33")
                    .style("stroke-width", "2px")
                    .style("fill", "FABD33")
                    .style("opacity", 0.25);


                // Add the valueline path.
                svg.append("path")
                    .data([data])
                    .attr("class", "line")
                    .attr("d", valueline);



                var circles = svg.selectAll("circle")
                    .data(data)
                    .enter()
                    .append("circle");


                circles.attr("cx", function(d) {
                        return x((d.Year))
                    })
                    .attr("cy", function(d) {
                        return y((d.Value))
                    })
                    .attr("r", 3)
                    .style("opacity", 1); // this is optional - if you want visible dots or not!

                circles
                    .on("mouseover", mouseoverFunc)
                    .on("mousemove", mousemoveFunc)
                    .on("mouseout", mouseoutFunc);

                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).ticks(5))
                    .style("font-size", "15px");

                // Add the Y Axis

                svg.append("g")
                    .call(d3.axisLeft(y).ticks(5).tickSize(-browserwidth + 95))
                    .style("font-size", "15px");


            }

            function mouseoverFunc(d) {
                // Adding a subtle animation to increase the dot size when over it!
                d3.select(this)
                    .transition()
                    .duration(50)
                    .style("opacity", 1)
                    .attr("r", 7);
                tooltip
                    .style("display", null) // this removes the display none setting from it
                    .html("<h5><b>" + d.Value.toFixed(2) + 
                        "</b><br>" + months[d.Year.getUTCMonth()] + " " + d.Year.getFullYear()  + "</h5>");
            }

            function mousemoveFunc(d) {
                tooltip
                    .style("top", (d3.event.pageY - 100) + "px")
                    .style("left", (d3.event.pageX + 5) + "px");
            }

            function mouseoutFunc(d) {
                // shrink it back down:
                d3.select(this)
                    .transition()
                    .style("opacity", 0)
                    .attr("r", 3);
                tooltip.style("display", "none"); // this sets it to invisible!
            }

            function getQueryVariable(variable) {
                var query = window.location.search.substring(1);
                var vars = query.split("&");
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split("=");
                    if (pair[0] == variable) { return pair[1]; }
                }


                return (false);
            }

            function download(filename, text) {
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                element.setAttribute('download', filename);

                element.style.display = 'none';
                document.body.appendChild(element);

                element.click();

                document.body.removeChild(element);
            }

            function responsivefy(svg) {
                // get container + svg aspect ratio
                var container = d3.select(svg.node().parentNode),
                    width = parseInt(svg.style("width")),
                    height = parseInt(svg.style("height")),
                    aspect = width / height;

                // add viewBox and preserveAspectRatio properties,
                // and call resize so that svg resizes on inital page load
                svg.attr("viewBox", "0 0 " + width + " " + height)
                    .attr("perserveAspectRatio", "xMinYMid")
                    .call(resize);

                // to register multiple listeners for same event type, 
                // you need to add namespace, i.e., 'click.foo'
                // necessary if you call invoke this function for multiple svgs
                // api docs: https://github.com/mbostock/d3/wiki/Selections#on
                d3.select(window).on("resize." + container.attr("id"), resize);

                // get width of container and resize svg to fit it
                function resize() {
                    var targetWidth = parseInt(container.style("width"));
                    svg.attr("width", targetWidth);
                    svg.attr("height", Math.round(targetWidth / aspect));
                }
            }


        });
        </script>
        <a id="download" href=#>Download as csv</a>
</body>